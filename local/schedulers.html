<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Schedulers - The Kompact Book</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A User Guide, Manual, and Tutorial for the Kompact actor-component-hybrid systems.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../foreword.html">Foreword</a></li><li class="chapter-item expanded affix "><a href="../getting-started.html">Getting Started</a></li><li class="chapter-item expanded "><a href="../introduction/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../introduction/components.html"><strong aria-hidden="true">1.1.</strong> Components</a></li><li class="chapter-item expanded "><a href="../introduction/actors.html"><strong aria-hidden="true">1.2.</strong> Actors</a></li><li class="chapter-item expanded "><a href="../introduction/state.html"><strong aria-hidden="true">1.3.</strong> Internal State</a></li></ol></li><li class="chapter-item expanded "><a href="../local/index.html"><strong aria-hidden="true">2.</strong> Local Kompact</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../local/communication/index.html"><strong aria-hidden="true">2.1.</strong> Communication</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../local/communication/messagesandevents.html"><strong aria-hidden="true">2.1.1.</strong> Messages and Events</a></li><li class="chapter-item expanded "><a href="../local/communication/state.html"><strong aria-hidden="true">2.1.2.</strong> State</a></li><li class="chapter-item expanded "><a href="../local/communication/handlers.html"><strong aria-hidden="true">2.1.3.</strong> Handlers</a></li><li class="chapter-item expanded "><a href="../local/communication/ask.html"><strong aria-hidden="true">2.1.4.</strong> Ask</a></li><li class="chapter-item expanded "><a href="../local/communication/system.html"><strong aria-hidden="true">2.1.5.</strong> System</a></li><li class="chapter-item expanded "><a href="../local/communication/senders.html"><strong aria-hidden="true">2.1.6.</strong> Senders</a></li></ol></li><li class="chapter-item expanded "><a href="../local/timers.html"><strong aria-hidden="true">2.2.</strong> Timers</a></li><li class="chapter-item expanded "><a href="../local/schedulers.html" class="active"><strong aria-hidden="true">2.3.</strong> Schedulers</a></li><li class="chapter-item expanded "><a href="../local/logging.html"><strong aria-hidden="true">2.4.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../local/configuration.html"><strong aria-hidden="true">2.5.</strong> Configuration</a></li></ol></li><li class="chapter-item expanded "><a href="../distributed/index.html"><strong aria-hidden="true">3.</strong> Distributed Kompact</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../distributed/basiccommunication.html"><strong aria-hidden="true">3.1.</strong> Basic Communication</a></li><li class="chapter-item expanded "><a href="../distributed/namedservices.html"><strong aria-hidden="true">3.2.</strong> Named Services</a></li><li class="chapter-item expanded "><a href="../distributed/serialisation.html"><strong aria-hidden="true">3.3.</strong> Serialisation</a></li><li class="chapter-item expanded "><a href="../distributed/networkbuffers.html"><strong aria-hidden="true">3.4.</strong> Configuring Buffers</a></li></ol></li><li class="chapter-item expanded "><a href="../async/index.html"><strong aria-hidden="true">4.</strong> Async/Await Interaction</a></li><li class="chapter-item expanded affix "><a href="../project.html">Project Info</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Kompact Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/kompics/kompact" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#schedulers" id="schedulers">Schedulers</a></h1>
<p>Kompact allows the core component scheduler to be exchanged, in order to support different kinds of workloads.
The default <code>crossbeam_workstealing_pool</code> scheduler from the <a href="https://docs.rs/executors/latest/executors/crossbeam_workstealing_pool/index.html">executors</a> crate, for example, is designed for fork-join type workloads. That is, workloads where a small number of (pool) external events spawns a large number of (pool) internal events. 
But not all workloads are of this type. Sometimes the majority of events are (pool) external, and there is little communication between components running on the thread pool. Our somewhat contrived “counter”-example from the <a href="../introduction/state.html">introduction</a> was of this nature, for example. We were sending events and messages from the main-thread to the <code>Counter</code>, which was running on Kompact’s thread-pool. But we never sent any messages or events to any other component on that pool. In fact, we also only had a single component, and running it a large thread pool seems rather silly. (Kompact’s default thread pool has one thread for each CPU core, as reported by <a href="https://crates.io/crates/num_cpus">num_cpus</a>.)</p>
<h2><a class="header" href="#changing-pool-size" id="changing-pool-size">Changing Pool Size</a></h2>
<p>We will first change just the pool size for the “counter”-example, since that is easily done. </p>
<p>The number of threads in Kompact’s thread pool is configured with the <code>threads(usize)</code> function on a <code>KompactConfig</code> instance. We will simply pass in <code>1usize</code> there, before constructing our Kompact system.</p>
<p>That we change this line</p>
<pre><code class="language-rust edition2018 no_run noplaypen"><span class="boring">use kompact::prelude::*;
</span><span class="boring">use std::time::Duration;
</span><span class="boring">
</span><span class="boring">#[derive(Clone, Debug, PartialEq, Eq)]
</span><span class="boring">struct CurrentCount {
</span><span class="boring">    messages: u64,
</span><span class="boring">    events: u64,
</span><span class="boring">}
</span><span class="boring">#[derive(Clone, Debug, PartialEq, Eq)]
</span><span class="boring">struct CountMe;
</span><span class="boring">
</span><span class="boring">struct CounterPort;
</span><span class="boring">impl Port for CounterPort {
</span><span class="boring">    type Indication = CurrentCount;
</span><span class="boring">    type Request = CountMe;
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[derive(ComponentDefinition)]
</span><span class="boring">struct Counter {
</span><span class="boring">    ctx: ComponentContext&lt;Self&gt;,
</span><span class="boring">    counter_port: ProvidedPort&lt;CounterPort&gt;,
</span><span class="boring">    msg_count: u64,
</span><span class="boring">    event_count: u64,
</span><span class="boring">}
</span><span class="boring">impl Counter {
</span><span class="boring">    pub fn new() -&gt; Self {
</span><span class="boring">        Counter {
</span><span class="boring">            ctx: ComponentContext::uninitialised(),
</span><span class="boring">            counter_port: ProvidedPort::uninitialised(),
</span><span class="boring">            msg_count: 0u64,
</span><span class="boring">            event_count: 0u64,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn current_count(&amp;self) -&gt; CurrentCount {
</span><span class="boring">        CurrentCount {
</span><span class="boring">            messages: self.msg_count,
</span><span class="boring">            events: self.event_count,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl ComponentLifecycle for Counter {
</span><span class="boring">    fn on_start(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a start event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn on_stop(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a stop event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn on_kill(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a kill event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Provide&lt;CounterPort&gt; for Counter {
</span><span class="boring">    fn handle(&amp;mut self, _event: CountMe) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a counter event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        self.counter_port.trigger(self.current_count());
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Actor for Counter {
</span><span class="boring">    type Message = Ask&lt;CountMe, CurrentCount&gt;;
</span><span class="boring">
</span><span class="boring">    fn receive_local(&amp;mut self, msg: Self::Message) -&gt; Handled {
</span><span class="boring">        msg.complete(|_request| {
</span><span class="boring">            info!(self.ctx.log(), &quot;Got a message!&quot;);
</span><span class="boring">            self.msg_count += 1u64;
</span><span class="boring">            self.current_count()
</span><span class="boring">        })
</span><span class="boring">        .expect(&quot;complete&quot;);
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn receive_network(&amp;mut self, _msg: NetMessage) -&gt; Handled {
</span><span class="boring">        unimplemented!(&quot;We are still ignoring network messages.&quot;);
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub fn main() {
</span>    let system = KompactConfig::default().build().expect(&quot;system&quot;);
<span class="boring">    let counter = system.create(Counter::new);
</span><span class="boring">    system.start(&amp;counter);
</span><span class="boring">    let actor_ref = counter.actor_ref();
</span><span class="boring">    let port_ref: ProvidedRef&lt;CounterPort&gt; = counter.provided_ref();
</span><span class="boring">    for _i in 0..100 {
</span><span class="boring">        let current_count = actor_ref.ask(Ask::of(CountMe)).wait();
</span><span class="boring">        info!(system.logger(), &quot;The current count is: {:?}&quot;, current_count);
</span><span class="boring">    }
</span><span class="boring">    for _i in 0..100 {
</span><span class="boring">        system.trigger_r(CountMe, &amp;port_ref);
</span><span class="boring">        // Where do the answers go?
</span><span class="boring">    }
</span><span class="boring">    std::thread::sleep(Duration::from_millis(1000));
</span><span class="boring">    let current_count = actor_ref.ask(Ask::of(CountMe)).wait();
</span><span class="boring">    info!(system.logger(), &quot;The final count is: {:?}&quot;, current_count);
</span><span class="boring">    system.shutdown().expect(&quot;shutdown&quot;);
</span><span class="boring">    // Wait a bit longer, so all output is logged (asynchronously) before shutting down
</span><span class="boring">    std::thread::sleep(Duration::from_millis(10));
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[cfg(test)]
</span><span class="boring">mod tests {
</span><span class="boring">    use super::*;
</span><span class="boring">
</span><span class="boring">    #[test]
</span><span class="boring">    fn test_counters() {
</span><span class="boring">        main();
</span><span class="boring">    }
</span><span class="boring">}
</span></code></pre>
<p>to this:</p>
<pre><code class="language-rust edition2018 no_run noplaypen"><span class="boring">use kompact::prelude::*;
</span><span class="boring">use std::time::Duration;
</span><span class="boring">
</span><span class="boring">#[derive(Clone, Debug, PartialEq, Eq)]
</span><span class="boring">struct CurrentCount {
</span><span class="boring">    messages: u64,
</span><span class="boring">    events: u64,
</span><span class="boring">}
</span><span class="boring">#[derive(Clone, Debug, PartialEq, Eq)]
</span><span class="boring">struct CountMe;
</span><span class="boring">
</span><span class="boring">struct CounterPort;
</span><span class="boring">impl Port for CounterPort {
</span><span class="boring">    type Indication = CurrentCount;
</span><span class="boring">    type Request = CountMe;
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[derive(ComponentDefinition)]
</span><span class="boring">struct Counter {
</span><span class="boring">    ctx: ComponentContext&lt;Self&gt;,
</span><span class="boring">    counter_port: ProvidedPort&lt;CounterPort&gt;,
</span><span class="boring">    msg_count: u64,
</span><span class="boring">    event_count: u64,
</span><span class="boring">}
</span><span class="boring">impl Counter {
</span><span class="boring">    pub fn new() -&gt; Self {
</span><span class="boring">        Counter {
</span><span class="boring">            ctx: ComponentContext::uninitialised(),
</span><span class="boring">            counter_port: ProvidedPort::uninitialised(),
</span><span class="boring">            msg_count: 0u64,
</span><span class="boring">            event_count: 0u64,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn current_count(&amp;self) -&gt; CurrentCount {
</span><span class="boring">        CurrentCount {
</span><span class="boring">            messages: self.msg_count,
</span><span class="boring">            events: self.event_count,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">impl ComponentLifecycle for Counter {
</span><span class="boring">    fn on_start(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a start event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn on_stop(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a stop event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn on_kill(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a kill event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">impl Provide&lt;CounterPort&gt; for Counter {
</span><span class="boring">    fn handle(&amp;mut self, _event: CountMe) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a counter event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        self.counter_port.trigger(self.current_count());
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Actor for Counter {
</span><span class="boring">    type Message = Ask&lt;CountMe, CurrentCount&gt;;
</span><span class="boring">
</span><span class="boring">    fn receive_local(&amp;mut self, msg: Self::Message) -&gt; Handled {
</span><span class="boring">        msg.complete(|_request| {
</span><span class="boring">            info!(self.ctx.log(), &quot;Got a message!&quot;);
</span><span class="boring">            self.msg_count += 1u64;
</span><span class="boring">            self.current_count()
</span><span class="boring">        })
</span><span class="boring">        .expect(&quot;complete&quot;);
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn receive_network(&amp;mut self, _msg: NetMessage) -&gt; Handled {
</span><span class="boring">        unimplemented!(&quot;We are still ignoring network messages.&quot;);
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub fn main() {
</span>    let mut conf = KompactConfig::default();
    conf.threads(1usize);
    let system = conf.build().expect(&quot;system&quot;);
<span class="boring">    let counter = system.create(Counter::new);
</span><span class="boring">    system.start(&amp;counter);
</span><span class="boring">    let actor_ref = counter.actor_ref();
</span><span class="boring">    let port_ref: ProvidedRef&lt;CounterPort&gt; = counter.provided_ref();
</span><span class="boring">    for _i in 0..100 {
</span><span class="boring">        let current_count = actor_ref.ask(Ask::of(CountMe)).wait();
</span><span class="boring">        info!(system.logger(), &quot;The current count is: {:?}&quot;, current_count);
</span><span class="boring">    }
</span><span class="boring">    for _i in 0..100 {
</span><span class="boring">        system.trigger_r(CountMe, &amp;port_ref);
</span><span class="boring">        // Where do the answers go?
</span><span class="boring">    }
</span><span class="boring">    std::thread::sleep(Duration::from_millis(1000));
</span><span class="boring">    let current_count = actor_ref.ask(Ask::of(CountMe)).wait();
</span><span class="boring">    info!(system.logger(), &quot;The final count is: {:?}&quot;, current_count);
</span><span class="boring">    system.shutdown().expect(&quot;shutdown&quot;);
</span><span class="boring">    // Wait a bit longer, so all output is logged (asynchronously) before shutting down
</span><span class="boring">    std::thread::sleep(Duration::from_millis(10));
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[cfg(test)]
</span><span class="boring">mod tests {
</span><span class="boring">    use super::*;
</span><span class="boring">
</span><span class="boring">    #[test]
</span><span class="boring">    fn test_counters() {
</span><span class="boring">        main();
</span><span class="boring">    }
</span><span class="boring">}
</span></code></pre>
<p>If we run this, we will see exactly (modulo event timing) the same output as when running on the larger pool with Kompact’s default settings.</p>
<blockquote>
<p><strong>Note:</strong> As before, if you have checked out the <a href="https://github.com/kompics/kompact/tree/master/docs/examples">examples folder</a> you can run the concrete binary with:</p>
<pre><code class="language-bash">cargo run --release --bin counters_pool
</code></pre>
</blockquote>
<h2><a class="header" href="#changing-scheduler-implementation" id="changing-scheduler-implementation">Changing Scheduler Implementation</a></h2>
<p>Ok, so now we’ll switch to a pool that is designed for external events: <code>crossbeam_channel_pool</code>, also from the <a href="https://docs.rs/executors/latest/executors/crossbeam_channel_pool/index.html">executors</a> crate. </p>
<p>We can set the scheduler implementation to be used by our Kompact system using the <code>executor(...)</code> function on a <code>KompactConfig</code> instance. That function expects a closure from the number of threads (<code>usize</code>) to something that implements the <code>executors::FuturesExecutor</code> <a href="https://docs.rs/executors/latest/executors/trait.FuturesExecutor.html">trait</a>.</p>
<blockquote>
<p><strong>Note:</strong> There is actually a more general API for changing scheduler, in the <code>scheduler(...)</code> function, which expects a function returning a <code>Box&lt;dyn kompact::runtime::Scheduler&gt;</code>. The <code>executor(...)</code> function is simply a shortcut for using schedulers that are compatible with the <a href="https://crates.io/crates/executors">executors</a> crate.</p>
</blockquote>
<p>In order to use the <code>crossbeam_channel_pool</code> scheduler, we need to import the <code>kompact::executors</code> module, which is simply a re-export from the <a href="https://crates.io/crates/executors">executors</a> crate:</p>
<pre><code class="language-rust edition2018 no_run noplaypen">use kompact::executors;
</code></pre>
<p>With that, all we need to add is the following line of code, which selects the <code>ThreadPool</code> implementation from the <code>crossbeam_channel_pool</code> module, instead of the one from the <code>crossbeam_workstealing_pool</code> module, that is default.</p>
<pre><code class="language-rust edition2018 no_run noplaypen"><span class="boring">use kompact::{executors, prelude::*};
</span><span class="boring">use std::time::Duration;
</span><span class="boring">
</span><span class="boring">#[derive(Clone, Debug, PartialEq, Eq)]
</span><span class="boring">struct CurrentCount {
</span><span class="boring">    messages: u64,
</span><span class="boring">    events: u64,
</span><span class="boring">}
</span><span class="boring">#[derive(Clone, Debug, PartialEq, Eq)]
</span><span class="boring">struct CountMe;
</span><span class="boring">
</span><span class="boring">struct CounterPort;
</span><span class="boring">impl Port for CounterPort {
</span><span class="boring">    type Indication = CurrentCount;
</span><span class="boring">    type Request = CountMe;
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[derive(ComponentDefinition)]
</span><span class="boring">struct Counter {
</span><span class="boring">    ctx: ComponentContext&lt;Self&gt;,
</span><span class="boring">    counter_port: ProvidedPort&lt;CounterPort&gt;,
</span><span class="boring">    msg_count: u64,
</span><span class="boring">    event_count: u64,
</span><span class="boring">}
</span><span class="boring">impl Counter {
</span><span class="boring">    pub fn new() -&gt; Self {
</span><span class="boring">        Counter {
</span><span class="boring">            ctx: ComponentContext::uninitialised(),
</span><span class="boring">            counter_port: ProvidedPort::uninitialised(),
</span><span class="boring">            msg_count: 0u64,
</span><span class="boring">            event_count: 0u64,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn current_count(&amp;self) -&gt; CurrentCount {
</span><span class="boring">        CurrentCount {
</span><span class="boring">            messages: self.msg_count,
</span><span class="boring">            events: self.event_count,
</span><span class="boring">        }
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">impl ComponentLifecycle for Counter {
</span><span class="boring">    fn on_start(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a start event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn on_stop(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a stop event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn on_kill(&amp;mut self) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a kill event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">impl Provide&lt;CounterPort&gt; for Counter {
</span><span class="boring">    fn handle(&amp;mut self, _event: CountMe) -&gt; Handled {
</span><span class="boring">        info!(self.ctx.log(), &quot;Got a counter event!&quot;);
</span><span class="boring">        self.event_count += 1u64;
</span><span class="boring">        self.counter_port.trigger(self.current_count());
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">impl Actor for Counter {
</span><span class="boring">    type Message = Ask&lt;CountMe, CurrentCount&gt;;
</span><span class="boring">
</span><span class="boring">    fn receive_local(&amp;mut self, msg: Self::Message) -&gt; Handled {
</span><span class="boring">        msg.complete(|_request| {
</span><span class="boring">            info!(self.ctx.log(), &quot;Got a message!&quot;);
</span><span class="boring">            self.msg_count += 1u64;
</span><span class="boring">            self.current_count()
</span><span class="boring">        })
</span><span class="boring">        .expect(&quot;complete&quot;);
</span><span class="boring">        Handled::Ok
</span><span class="boring">    }
</span><span class="boring">
</span><span class="boring">    fn receive_network(&amp;mut self, _msg: NetMessage) -&gt; Handled {
</span><span class="boring">        unimplemented!(&quot;We are still ignoring network messages.&quot;);
</span><span class="boring">    }
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">pub fn main() {
</span><span class="boring">    let mut conf = KompactConfig::default();
</span><span class="boring">    conf.threads(1usize);
</span>    conf.executor(executors::crossbeam_channel_pool::ThreadPool::new);
<span class="boring">    let system = conf.build().expect(&quot;system&quot;);
</span><span class="boring">    let counter = system.create(Counter::new);
</span><span class="boring">    system.start(&amp;counter);
</span><span class="boring">    let actor_ref = counter.actor_ref();
</span><span class="boring">    let port_ref: ProvidedRef&lt;CounterPort&gt; = counter.provided_ref();
</span><span class="boring">    for _i in 0..100 {
</span><span class="boring">        let current_count = actor_ref.ask(Ask::of(CountMe)).wait();
</span><span class="boring">        info!(system.logger(), &quot;The current count is: {:?}&quot;, current_count);
</span><span class="boring">    }
</span><span class="boring">    for _i in 0..100 {
</span><span class="boring">        system.trigger_r(CountMe, &amp;port_ref);
</span><span class="boring">        // Where do the answers go?
</span><span class="boring">    }
</span><span class="boring">    std::thread::sleep(Duration::from_millis(1000));
</span><span class="boring">    let current_count = actor_ref.ask(Ask::of(CountMe)).wait();
</span><span class="boring">    info!(system.logger(), &quot;The final count is: {:?}&quot;, current_count);
</span><span class="boring">    system.shutdown().expect(&quot;shutdown&quot;);
</span><span class="boring">    // Wait a bit longer, so all output is logged (asynchronously) before shutting down
</span><span class="boring">    std::thread::sleep(Duration::from_millis(10));
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[cfg(test)]
</span><span class="boring">mod tests {
</span><span class="boring">    use super::*;
</span><span class="boring">
</span><span class="boring">    #[test]
</span><span class="boring">    fn test_counters() {
</span><span class="boring">        main();
</span><span class="boring">    }
</span><span class="boring">}
</span></code></pre>
<p>If we run this, again, we will see exactly (modulo event timing) the same output as when running on the larger pool with Kompact’s default settings.</p>
<blockquote>
<p><strong>Note:</strong> As before, if you have checked out the <a href="https://github.com/kompics/kompact/tree/master/docs/examples">examples folder</a> you can run the concrete binary with:</p>
<pre><code class="language-bash">cargo run --release --bin counters_channel_pool
</code></pre>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../local/timers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../local/logging.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../local/timers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../local/logging.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
